<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Dashboard - IoT</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dark-theme">
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-logo"><h2>üè† IoT</h2></div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html" class="active"><span class="icon">üìä</span><span id="nav-dashboard">Dashboard</span></a></li>
                <li id="menu-slots" style="display:none"><a href="slots.html"><span class="icon">üì±</span><span id="nav-slots">Qu·∫£n l√Ω Slots</span></a></li>
                <li id="menu-admin" style="display:none"><a href="admin.html"><span class="icon">üëë</span><span>Admin</span></a></li>
                <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span id="nav-settings">C√†i ƒë·∫∑t</span></a></li>
            </ul>
        </nav>
        <main class="main-content">
            <header class="header">
                <div>
                    <h1>üìä Dashboard</h1>
                    <div id="mqtt-status"></div>
                </div>
                <div class="header-right">
                    <div id="clock"></div>
                    <div class="user-info">
                        <div class="user-name" id="user-name">User</div>
                        <div class="user-role" id="user-role">USER</div>
                    </div>
                    <button class="btn-logout" onclick="logout()" id="btn-logout">ƒêƒÉng xu·∫•t</button>
                </div>
            </header>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-icon">üì±</div><div class="stat-value" id="stat-slots">0</div><div class="stat-label" id="label-total">T·ªïng Slots</div></div>
                <div class="stat-card"><div class="stat-icon">üì∑</div><div class="stat-value" id="stat-cameras">0</div><div class="stat-label">Camera</div></div>
                <div class="stat-card"><div class="stat-icon">üí°</div><div class="stat-value" id="stat-controls">0</div><div class="stat-label" id="label-controls">ƒêi·ªÅu khi·ªÉn</div></div>
                <div class="stat-card stat-alert" id="stat-alert-card" onclick="toggleAlertsPanel()"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-value" id="stat-alerts">0</div><div class="stat-label" id="label-alerts">C·∫£nh b√°o</div></div>
            </div>
            
            <!-- Alerts Panel -->
            <div id="alerts-panel" class="alerts-panel" style="display:none">
                <div class="alerts-header">
                    <h3>‚ö†Ô∏è <span id="alerts-title">C·∫£nh b√°o</span></h3>
                    <div class="alerts-actions">
                        <button class="btn btn-sm" onclick="markAllAlertsRead()">‚úì ƒê·ªçc t·∫•t c·∫£</button>
                        <button class="btn btn-sm btn-close" onclick="toggleAlertsPanel()">‚úï</button>
                    </div>
                </div>
                <div id="alerts-list" class="alerts-list">
                    <p class="text-center">ƒêang t·∫£i...</p>
                </div>
            </div>
            
            <div id="slots-container"></div>
        </main>
    </div>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        const texts = {
            vi: {
                navDashboard: 'Dashboard', navSlots: 'Qu·∫£n l√Ω Slots', navSettings: 'C√†i ƒë·∫∑t',
                btnLogout: 'ƒêƒÉng xu·∫•t', labelTotal: 'T·ªïng Slots', labelControls: 'ƒêi·ªÅu khi·ªÉn',
                labelCharts: 'Bi·ªÉu ƒë·ªì', labelAlerts: 'C·∫£nh b√°o', connected: 'ƒê√£ k·∫øt n·ªëi', disconnected: 'M·∫•t k·∫øt n·ªëi',
                value: 'Gi√° tr·ªã s·ªë', status: 'Tr·∫°ng th√°i', control: 'ƒêi·ªÅu khi·ªÉn', camera: 'Camera',
                chart: 'Bi·ªÉu ƒë·ªì', on: 'B·∫¨T', off: 'T·∫ÆT', noDevice: 'Ch∆∞a c√≥ thi·∫øt b·ªã',
                addDevice: 'Th√™m thi·∫øt b·ªã', justNow: 'V·ª´a xong', minutesAgo: 'ph√∫t tr∆∞·ªõc', hoursAgo: 'gi·ªù tr∆∞·ªõc',
                alertHigh: 'V∆∞·ª£t ng∆∞·ª°ng cao', alertLow: 'D∆∞·ªõi ng∆∞·ª°ng th·∫•p', noAlerts: 'Kh√¥ng c√≥ c·∫£nh b√°o',
                alertsTitle: 'C·∫£nh b√°o'
            },
            en: {
                navDashboard: 'Dashboard', navSlots: 'Manage Slots', navSettings: 'Settings',
                btnLogout: 'Logout', labelTotal: 'Total Slots', labelControls: 'Controls',
                labelCharts: 'Charts', labelAlerts: 'Alerts', connected: 'Connected', disconnected: 'Disconnected',
                value: 'Value', status: 'Status', control: 'Control', camera: 'Camera',
                chart: 'Chart', on: 'ON', off: 'OFF', noDevice: 'No device',
                addDevice: 'Add device', justNow: 'Just now', minutesAgo: 'min ago', hoursAgo: 'hours ago',
                alertHigh: 'Above threshold', alertLow: 'Below threshold', noAlerts: 'No alerts',
                alertsTitle: 'Alerts'
            }
        };
        
        let lang = localStorage.getItem('language') || 'vi';
        let txt = texts[lang];
        let refreshInterval = null;
        
        function applyLanguage() {
            document.getElementById('nav-dashboard').textContent = txt.navDashboard;
            document.getElementById('nav-slots').textContent = txt.navSlots;
            document.getElementById('nav-settings').textContent = txt.navSettings;
            document.getElementById('btn-logout').textContent = txt.btnLogout;
            document.getElementById('label-total').textContent = txt.labelTotal;
            document.getElementById('label-controls').textContent = txt.labelControls;
            document.getElementById('label-alerts').textContent = txt.labelAlerts;
            document.getElementById('alerts-title').textContent = txt.alertsTitle;
        }
        
        let alertsData = [];
        let alertsStatus = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            initSettings(); applyLanguage(); displayUserInfo(); loadDashboard();
            startAutoRefresh(); startClock();
            const user = getCurrentUser();
            if (user && user.role === 'admin') {
                document.getElementById('menu-slots').style.display = 'block';
                document.getElementById('menu-admin').style.display = 'block';
            }
        });
        
        function displayUserInfo() {
            const user = getCurrentUser();
            if (user) {
                document.getElementById('user-name').textContent = user.name || user.email;
                document.getElementById('user-role').textContent = user.role.toUpperCase();
            }
        }
        
        async function loadDashboard() {
            const data = await apiCall('/api/dashboard/full');
            if (!data || !data.success) return;
            alertsStatus = data.alerts_status || {};
            displayStats(data.stats, data.unread_alerts);
            displayMqttStatus(data.mqtt);
            displaySlots(data.slots, data.data);
        }
        
        function displayStats(stats, unreadAlerts) {
            document.getElementById('stat-slots').textContent = stats.total_slots || 0;
            document.getElementById('stat-cameras').textContent = stats.total_cameras || 0;
            document.getElementById('stat-controls').textContent = stats.total_controls || 0;
            document.getElementById('stat-alerts').textContent = unreadAlerts || 0;
            
            const alertCard = document.getElementById('stat-alert-card');
            if (unreadAlerts > 0) {
                alertCard.classList.add('has-alerts');
            } else {
                alertCard.classList.remove('has-alerts');
            }
        }
        
        function displayMqttStatus(mqtt) {
            const el = document.getElementById('mqtt-status');
            if (el) el.innerHTML = mqtt.connected 
                ? `<span class="status-dot connected"></span> ${txt.connected}`
                : `<span class="status-dot disconnected"></span> ${txt.disconnected}`;
        }
        
        function displaySlots(slots, data) {
            const container = document.getElementById('slots-container');
            if (!slots || slots.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>üì≠ ${txt.noDevice}</p>
                    ${isAdmin() ? `<a href="slots.html" class="btn btn-primary">${txt.addDevice}</a>` : ''}</div>`;
                return;
            }
            let html = '';
            
            // Value slots
            const valueSlots = slots.filter(s => s.type === 'value');
            if (valueSlots.length > 0) {
                html += `<div class="slots-section"><h3>üìä ${txt.value}</h3><div class="slots-grid">`;
                valueSlots.forEach(slot => {
                    const d = data[slot.slot_number];
                    const alertState = alertsStatus[slot.slot_number];
                    const alertClass = alertState ? (alertState.type === 'high' ? 'alert-high' : 'alert-low') : '';
                    const alertIndicator = alertState ? `<div class="alert-indicator ${alertState.type}">${alertState.type === 'high' ? 'üî¥ ' + txt.alertHigh : 'üîµ ' + txt.alertLow}</div>` : '';
                    
                    html += `<div class="slot-card value-card ${alertClass}">
                        ${alertIndicator}
                        <div class="slot-icon">${slot.icon || 'üìü'}</div>
                        <div class="slot-name">${slot.name}</div>
                        <div class="slot-value ${alertClass}">${d ? d.value : '--'}<span class="slot-unit">${slot.unit || ''}</span></div>
                        ${slot.alert_enabled ? `<div class="slot-thresholds">‚Üì${slot.alert_min !== null ? slot.alert_min : '-'} | ‚Üë${slot.alert_max !== null ? slot.alert_max : '-'}</div>` : ''}
                        <div class="slot-location">${slot.location || ''}</div>
                        <div class="slot-time">${d ? formatTime(d.created_at) : ''}</div>
                    </div>`;
                });
                html += '</div></div>';
            }
            
            // Status slots
            const statusSlots = slots.filter(s => s.type === 'status');
            if (statusSlots.length > 0) {
                html += `<div class="slots-section"><h3>üîî ${txt.status}</h3><div class="slots-grid">`;
                statusSlots.forEach(slot => {
                    const d = data[slot.slot_number];
                    const isOn = d && (d.value === '1' || d.value === 1);
                    html += `<div class="slot-card status-card ${isOn ? 'on' : 'off'}">
                        <div class="slot-icon">${slot.icon || 'üîî'}</div>
                        <div class="slot-name">${slot.name}</div>
                        <div class="status-indicator"><span class="dot ${isOn ? 'on' : 'off'}"></span> ${isOn ? txt.on : txt.off}</div>
                        <div class="slot-location">${slot.location || ''}</div>
                    </div>`;
                });
                html += '</div></div>';
            }
            
            // Control slots
            const controlSlots = slots.filter(s => s.type === 'control');
            if (controlSlots.length > 0) {
                html += `<div class="slots-section"><h3>üí° ${txt.control}</h3><div class="slots-grid">`;
                controlSlots.forEach(slot => {
                    const d = data[slot.slot_number];
                    const isOn = d && (d.value === '1' || d.value === 1);
                    const canControl = isOperator();
                    html += `<div class="slot-card control-card">
                        <div class="slot-icon">${slot.icon || 'üí°'}</div>
                        <div class="slot-name">${slot.name}</div>
                        ${canControl ? `<label class="toggle-switch"><input type="checkbox" ${isOn ? 'checked' : ''} onchange="toggleControl(${slot.slot_number}, this.checked)"><span class="slider"></span></label>`
                        : `<div class="status-indicator"><span class="dot ${isOn ? 'on' : 'off'}"></span> ${isOn ? txt.on : txt.off}</div>`}
                        <div class="slot-location">${slot.location || ''}</div>
                    </div>`;
                });
                html += '</div></div>';
            }
            
            // Camera slots
            const cameraSlots = slots.filter(s => s.type === 'camera');
            if (cameraSlots.length > 0) {
                html += `<div class="slots-section"><h3>üì∑ ${txt.camera}</h3><div class="slots-grid cameras-grid">`;
                cameraSlots.forEach(slot => {
                    html += `<div class="slot-card camera-card">
                        <div class="slot-name">${slot.name}</div>
                        <div class="camera-container">
                            ${slot.stream_url ? `<img id="camera-${slot.slot_number}" src="${slot.stream_url}" class="camera-image" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22320%22 height=%22240%22><rect fill=%22%23333%22 width=%22100%%22 height=%22100%%22/><text x=%2250%%22 y=%2250%%22 fill=%22%23666%22 text-anchor=%22middle%22>No Signal</text></svg>'">`
                            : `<img id="camera-${slot.slot_number}" src="" class="camera-image">`}
                        </div>
                        <div class="slot-location">${slot.location || ''}</div>
                    </div>`;
                    if (!slot.stream_url) loadCameraImage(slot.slot_number);
                });
                html += '</div></div>';
            }
            
            // Chart slots
            const chartSlots = slots.filter(s => s.type === 'chart');
            if (chartSlots.length > 0) {
                html += `<div class="slots-section"><h3>üìà ${txt.chart}</h3><div class="charts-grid">`;
                chartSlots.forEach(slot => {
                    const d = data[slot.slot_number];
                    const alertState = alertsStatus[slot.slot_number];
                    const alertClass = alertState ? (alertState.type === 'high' ? 'alert-high' : 'alert-low') : '';
                    const alertIndicator = alertState ? `<div class="alert-indicator ${alertState.type}">${alertState.type === 'high' ? 'üî¥ ' + txt.alertHigh : 'üîµ ' + txt.alertLow}</div>` : '';
                    
                    html += `<div class="slot-card chart-card ${alertClass}">
                        ${alertIndicator}
                        <div class="slot-name">${slot.name} ${d ? `<span class="current-value ${alertClass}">${d.value}${slot.unit || ''}</span>` : ''}</div>
                        ${slot.alert_enabled ? `<div class="slot-thresholds">‚Üì${slot.alert_min !== null ? slot.alert_min : '-'} | ‚Üë${slot.alert_max !== null ? slot.alert_max : '-'}</div>` : ''}
                        <canvas id="chart-${slot.slot_number}"></canvas>
                        <div class="slot-location">${slot.location || ''}</div>
                    </div>`;
                });
                html += '</div></div>';
                setTimeout(() => chartSlots.forEach(s => loadChart(s)), 100);
            }
            
            container.innerHTML = html;
        }
        
        async function toggleControl(num, isOn) {
            const data = await apiCall(`/api/control/${num}`, 'POST', { command: isOn ? 1 : 0 });
            if (!data || !data.success) loadDashboard();
        }
        
        async function loadCameraImage(num) {
            const data = await apiCall(`/api/camera/${num}`);
            if (data && data.success && data.data && data.data.image_data) {
                const img = document.getElementById(`camera-${num}`);
                if (img) img.src = data.data.image_data;
            }
        }
        
        async function loadChart(slot) {
            const data = await apiCall(`/api/data/${slot.slot_number}/history?limit=20`);
            if (!data || !data.success || !data.data) return;
            const canvas = document.getElementById(`chart-${slot.slot_number}`);
            if (!canvas) return;
            const history = data.data.reverse();
            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: history.map(d => new Date(d.created_at).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'})),
                    datasets: [{ label: slot.name, data: history.map(d => parseFloat(d.value) || 0),
                        borderColor: '#4facfe', backgroundColor: 'rgba(79, 172, 254, 0.1)', tension: 0.3, fill: true }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                    scales: { x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } },
                             y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } } } }
            });
        }
        
        function formatTime(dateStr) {
            if (!dateStr) return '';
            const diff = Math.floor((new Date() - new Date(dateStr)) / 1000);
            if (diff < 60) return txt.justNow;
            if (diff < 3600) return Math.floor(diff / 60) + ' ' + txt.minutesAgo;
            if (diff < 86400) return Math.floor(diff / 3600) + ' ' + txt.hoursAgo;
            return new Date(dateStr).toLocaleDateString('vi-VN');
        }
        
        function startAutoRefresh() { 
            refreshInterval = setInterval(loadDashboard, REFRESH_INTERVAL);
            // Refresh camera nhanh h∆°n (m·ªói 600ms)
            setInterval(refreshCameras, 600);
        }
        
        async function refreshCameras() {
            const cameraImgs = document.querySelectorAll('[id^="camera-"]');
            for (const img of cameraImgs) {
                const slotNum = img.id.replace('camera-', '');
                if (!img.src.includes('http://') && !img.src.includes('https://192')) {
                    // Ch·ªâ refresh ·∫£nh MQTT, kh√¥ng refresh stream URL
                    const data = await apiCall(`/api/camera/${slotNum}`);
                    if (data && data.success && data.data && data.data.image_data) {
                        img.src = data.data.image_data;
                    }
                }
            }
        }
        
        // ===== ALERTS FUNCTIONS =====
        async function toggleAlertsPanel() {
            const panel = document.getElementById('alerts-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                await loadAlerts();
            } else {
                panel.style.display = 'none';
            }
        }
        
        async function loadAlerts() {
            const data = await apiCall('/api/alerts?limit=20');
            if (!data || !data.success) return;
            
            alertsData = data.data || [];
            const list = document.getElementById('alerts-list');
            
            if (alertsData.length === 0) {
                list.innerHTML = `<p class="text-center no-alerts">‚úÖ ${txt.noAlerts}</p>`;
                return;
            }
            
            list.innerHTML = alertsData.map(alert => `
                <div class="alert-item ${alert.is_read ? 'read' : 'unread'} ${alert.alert_type}">
                    <div class="alert-icon">${alert.alert_type === 'high' ? 'üî¥' : 'üîµ'}</div>
                    <div class="alert-content">
                        <div class="alert-slot">${alert.icon || 'üìü'} ${alert.slot_name || 'Slot ' + alert.slot_number}</div>
                        <div class="alert-message">${alert.message}</div>
                        <div class="alert-time">${formatTime(alert.created_at)}</div>
                    </div>
                    ${!alert.is_read ? `<button class="btn btn-sm btn-mark-read" onclick="markAlertRead(${alert.id})">‚úì</button>` : ''}
                </div>
            `).join('');
        }
        
        async function markAlertRead(alertId) {
            const res = await apiCall(`/api/alerts/${alertId}/read`, 'PUT');
            if (res && res.success) {
                loadAlerts();
                loadDashboard();
            }
        }
        
        async function markAllAlertsRead() {
            const res = await apiCall('/api/alerts/read-all', 'PUT');
            if (res && res.success) {
                loadAlerts();
                loadDashboard();
            }
        }
        
        function startClock() {
            const el = document.getElementById('clock');
            if (!el) return;
            function update() { el.textContent = new Date().toLocaleString(lang === 'en' ? 'en-US' : 'vi-VN'); }
            update(); setInterval(update, 1000);
        }
    </script>
</body>
</html>
