<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CÃ i Ä‘áº·t - IoT</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="dark-theme">
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-logo"><h2>ğŸ  IoT</h2></div>
            <ul class="sidebar-menu" id="sidebar-menu">
                <li><a href="dashboard.html"><span class="icon">ğŸ“Š</span><span>Dashboard</span></a></li>
                <li id="menu-slots" style="display:none"><a href="slots.html"><span class="icon">ğŸ“±</span><span>Quáº£n lÃ½ Slots</span></a></li>
                <li id="menu-admin" style="display:none"><a href="admin.html"><span class="icon">ğŸ‘‘</span><span>Admin</span></a></li>
                <li><a href="settings.html" class="active"><span class="icon">âš™ï¸</span><span>CÃ i Ä‘áº·t</span></a></li>
            </ul>
        </nav>
        <main class="main-content">
            <header class="header">
                <h1>âš™ï¸ CÃ i Ä‘áº·t</h1>
                <button class="btn-logout" onclick="logout()">ÄÄƒng xuáº¥t</button>
            </header>
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            
            <div class="settings-section">
                <h3>ğŸ‘¤ Há»“ sÆ¡</h3>
                <form onsubmit="updateProfile(event)">
                    <div class="form-group"><label>TÃªn</label><input type="text" id="profile-name"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="profile-email" disabled></div>
                    <button type="submit" class="btn btn-primary" style="width:auto">LÆ°u</button>
                </form>
            </div>
            
            <div class="settings-section">
                <h3>ğŸ”‘ Äá»•i máº­t kháº©u</h3>
                <form onsubmit="changePassword(event)">
                    <div class="form-group"><label>Máº­t kháº©u cÅ©</label><input type="password" id="old-password" required></div>
                    <div class="form-group"><label>Máº­t kháº©u má»›i</label><input type="password" id="new-password" required></div>
                    <div class="form-group"><label>XÃ¡c nháº­n</label><input type="password" id="confirm-password" required></div>
                    <button type="submit" class="btn btn-primary" style="width:auto">Äá»•i</button>
                </form>
            </div>
            
            <div class="settings-section">
                <h3>ğŸ¨ Giao diá»‡n</h3>
                <div class="settings-row">
                    <span>Cháº¿ Ä‘á»™</span>
                    <div class="settings-value">
                        <button class="theme-btn" id="theme-dark" onclick="setTheme('dark')">ğŸŒ™ Tá»‘i</button>
                        <button class="theme-btn" id="theme-light" onclick="setTheme('light')">â˜€ï¸ SÃ¡ng</button>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>ğŸŒ NgÃ´n ngá»¯</h3>
                <div class="settings-row">
                    <span>NgÃ´n ngá»¯</span>
                    <div class="settings-value">
                        <button class="lang-btn" id="lang-vi" onclick="setLanguage('vi')">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
                        <button class="lang-btn" id="lang-en" onclick="setLanguage('en')">ğŸ‡ºğŸ‡¸ English</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            initSettings(); loadProfile(); updateButtons();
            const user = getCurrentUser();
            if (user && user.role === 'admin') {
                document.getElementById('menu-slots').style.display = 'block';
                document.getElementById('menu-admin').style.display = 'block';
            }
        });
        async function loadProfile() {
            const data = await apiCall('/api/user/profile');
            if (data && data.success) {
                document.getElementById('profile-name').value = data.data.name || '';
                document.getElementById('profile-email').value = data.data.email || '';
            }
        }
        async function updateProfile(e) {
            e.preventDefault();
            const name = document.getElementById('profile-name').value.trim();
            const res = await apiCall('/api/user/profile', 'PUT', { name });
            if (res && res.success) {
                const user = getCurrentUser(); user.name = name;
                localStorage.setItem('user', JSON.stringify(user));
                showSuccess('ÄÃ£ cáº­p nháº­t!');
            }
        }
        async function changePassword(e) {
            e.preventDefault();
            const oldPw = document.getElementById('old-password').value;
            const newPw = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-password').value;
            if (newPw.length < 6) { showError('Máº­t kháº©u má»›i Ã­t nháº¥t 6 kÃ½ tá»±!'); return; }
            if (newPw !== confirm) { showError('Máº­t kháº©u khÃ´ng khá»›p!'); return; }
            const res = await apiCall('/api/user/password', 'PUT', { old_password: oldPw, new_password: newPw });
            if (res && res.success) {
                showSuccess('Äá»•i máº­t kháº©u thÃ nh cÃ´ng!');
                document.getElementById('old-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } else showError(res?.error || 'Lá»—i!');
        }
        function setTheme(theme) {
            localStorage.setItem('theme', theme); applyTheme(); updateButtons();
            apiCall('/api/user/profile', 'PUT', { theme });
        }
        function setLanguage(lang) {
            localStorage.setItem('language', lang); updateTexts(); updateButtons();
            apiCall('/api/user/profile', 'PUT', { language: lang });
        }
        function updateButtons() {
            const theme = localStorage.getItem('theme') || 'dark';
            const lang = localStorage.getItem('language') || 'vi';
            document.getElementById('theme-dark').classList.toggle('active', theme === 'dark');
            document.getElementById('theme-light').classList.toggle('active', theme === 'light');
            document.getElementById('lang-vi').classList.toggle('active', lang === 'vi');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        }
    </script>
</body>
</html>
