<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">CÃ i Ä‘áº·t - IoT</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="dark-theme">
    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-logo"><h2>ğŸ  IoT</h2></div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><span class="icon">ğŸ“Š</span><span id="nav-dashboard">Dashboard</span></a></li>
                <li id="menu-slots" style="display:none"><a href="slots.html"><span class="icon">ğŸ“±</span><span id="nav-slots">Quáº£n lÃ½ Slots</span></a></li>
                <li id="menu-admin" style="display:none"><a href="admin.html"><span class="icon">ğŸ‘‘</span><span>Admin</span></a></li>
                <li><a href="settings.html" class="active"><span class="icon">âš™ï¸</span><span id="nav-settings">CÃ i Ä‘áº·t</span></a></li>
            </ul>
        </nav>
        <main class="main-content">
            <header class="header">
                <h1 id="header-title">âš™ï¸ CÃ i Ä‘áº·t</h1>
                <button class="btn-logout" onclick="logout()" id="btn-logout">ÄÄƒng xuáº¥t</button>
            </header>
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            
            <div class="settings-section">
                <h3 id="section-profile">ğŸ‘¤ Há»“ sÆ¡</h3>
                <form onsubmit="updateProfile(event)">
                    <div class="form-group"><label id="label-name">TÃªn</label><input type="text" id="profile-name"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="profile-email" disabled></div>
                    <button type="submit" class="btn btn-primary" style="width:auto" id="btn-save">LÆ°u</button>
                </form>
            </div>
            
            <div class="settings-section">
                <h3 id="section-password">ğŸ”‘ Äá»•i máº­t kháº©u</h3>
                <form onsubmit="changePassword(event)">
                    <div class="form-group"><label id="label-old-pw">Máº­t kháº©u cÅ©</label><input type="password" id="old-password" required></div>
                    <div class="form-group"><label id="label-new-pw">Máº­t kháº©u má»›i</label><input type="password" id="new-password" required></div>
                    <div class="form-group"><label id="label-confirm">XÃ¡c nháº­n</label><input type="password" id="confirm-password" required></div>
                    <button type="submit" class="btn btn-primary" style="width:auto" id="btn-change">Äá»•i</button>
                </form>
            </div>
            
            <div class="settings-section">
                <h3 id="section-theme">ğŸ¨ Giao diá»‡n</h3>
                <div class="settings-row">
                    <span id="label-mode">Cháº¿ Ä‘á»™</span>
                    <div class="settings-value">
                        <button class="theme-btn" id="theme-dark" onclick="setTheme('dark')">ğŸŒ™ <span id="txt-dark">Tá»‘i</span></button>
                        <button class="theme-btn" id="theme-light" onclick="setTheme('light')">â˜€ï¸ <span id="txt-light">SÃ¡ng</span></button>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 id="section-lang">ğŸŒ NgÃ´n ngá»¯</h3>
                <div class="settings-row">
                    <span id="label-lang">NgÃ´n ngá»¯</span>
                    <div class="settings-value">
                        <button class="lang-btn" id="lang-vi" onclick="setLanguage('vi')">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</button>
                        <button class="lang-btn" id="lang-en" onclick="setLanguage('en')">ğŸ‡ºğŸ‡¸ English</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        const texts = {
            vi: {
                pageTitle: 'CÃ i Ä‘áº·t - IoT', headerTitle: 'âš™ï¸ CÃ i Ä‘áº·t', navDashboard: 'Dashboard',
                navSlots: 'Quáº£n lÃ½ Slots', navSettings: 'CÃ i Ä‘áº·t', btnLogout: 'ÄÄƒng xuáº¥t',
                sectionProfile: 'ğŸ‘¤ Há»“ sÆ¡', labelName: 'TÃªn', btnSave: 'LÆ°u',
                sectionPassword: 'ğŸ”‘ Äá»•i máº­t kháº©u', labelOldPw: 'Máº­t kháº©u cÅ©',
                labelNewPw: 'Máº­t kháº©u má»›i', labelConfirm: 'XÃ¡c nháº­n', btnChange: 'Äá»•i',
                sectionTheme: 'ğŸ¨ Giao diá»‡n', labelMode: 'Cháº¿ Ä‘á»™', txtDark: 'Tá»‘i', txtLight: 'SÃ¡ng',
                sectionLang: 'ğŸŒ NgÃ´n ngá»¯', labelLang: 'NgÃ´n ngá»¯',
                msgUpdated: 'ÄÃ£ cáº­p nháº­t!', msgPwChanged: 'Äá»•i máº­t kháº©u thÃ nh cÃ´ng!',
                errPwShort: 'Máº­t kháº©u má»›i Ã­t nháº¥t 6 kÃ½ tá»±!', errPwNoMatch: 'Máº­t kháº©u khÃ´ng khá»›p!'
            },
            en: {
                pageTitle: 'Settings - IoT', headerTitle: 'âš™ï¸ Settings', navDashboard: 'Dashboard',
                navSlots: 'Manage Slots', navSettings: 'Settings', btnLogout: 'Logout',
                sectionProfile: 'ğŸ‘¤ Profile', labelName: 'Name', btnSave: 'Save',
                sectionPassword: 'ğŸ”‘ Change Password', labelOldPw: 'Old Password',
                labelNewPw: 'New Password', labelConfirm: 'Confirm', btnChange: 'Change',
                sectionTheme: 'ğŸ¨ Theme', labelMode: 'Mode', txtDark: 'Dark', txtLight: 'Light',
                sectionLang: 'ğŸŒ Language', labelLang: 'Language',
                msgUpdated: 'Updated!', msgPwChanged: 'Password changed!',
                errPwShort: 'Password must be at least 6 characters!', errPwNoMatch: 'Passwords do not match!'
            }
        };
        
        let lang = localStorage.getItem('language') || 'vi';
        let txt = texts[lang];
        
        function applyLanguage() {
            document.getElementById('page-title').textContent = txt.pageTitle;
            document.getElementById('header-title').textContent = txt.headerTitle;
            document.getElementById('nav-dashboard').textContent = txt.navDashboard;
            document.getElementById('nav-slots').textContent = txt.navSlots;
            document.getElementById('nav-settings').textContent = txt.navSettings;
            document.getElementById('btn-logout').textContent = txt.btnLogout;
            document.getElementById('section-profile').textContent = txt.sectionProfile;
            document.getElementById('label-name').textContent = txt.labelName;
            document.getElementById('btn-save').textContent = txt.btnSave;
            document.getElementById('section-password').textContent = txt.sectionPassword;
            document.getElementById('label-old-pw').textContent = txt.labelOldPw;
            document.getElementById('label-new-pw').textContent = txt.labelNewPw;
            document.getElementById('label-confirm').textContent = txt.labelConfirm;
            document.getElementById('btn-change').textContent = txt.btnChange;
            document.getElementById('section-theme').textContent = txt.sectionTheme;
            document.getElementById('label-mode').textContent = txt.labelMode;
            document.getElementById('txt-dark').textContent = txt.txtDark;
            document.getElementById('txt-light').textContent = txt.txtLight;
            document.getElementById('section-lang').textContent = txt.sectionLang;
            document.getElementById('label-lang').textContent = txt.labelLang;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            initSettings(); applyLanguage(); loadProfile(); updateButtons();
            const user = getCurrentUser();
            if (user && user.role === 'admin') {
                document.getElementById('menu-slots').style.display = 'block';
                document.getElementById('menu-admin').style.display = 'block';
            }
        });
        
        async function loadProfile() {
            const data = await apiCall('/api/user/profile');
            if (data && data.success) {
                document.getElementById('profile-name').value = data.data.name || '';
                document.getElementById('profile-email').value = data.data.email || '';
            }
        }
        async function updateProfile(e) {
            e.preventDefault();
            const name = document.getElementById('profile-name').value.trim();
            const res = await apiCall('/api/user/profile', 'PUT', { name });
            if (res && res.success) {
                const user = getCurrentUser(); user.name = name;
                localStorage.setItem('user', JSON.stringify(user));
                showSuccess(txt.msgUpdated);
            }
        }
        async function changePassword(e) {
            e.preventDefault();
            const oldPw = document.getElementById('old-password').value;
            const newPw = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-password').value;
            if (newPw.length < 6) { showError(txt.errPwShort); return; }
            if (newPw !== confirm) { showError(txt.errPwNoMatch); return; }
            const res = await apiCall('/api/user/password', 'PUT', { old_password: oldPw, new_password: newPw });
            if (res && res.success) {
                showSuccess(txt.msgPwChanged);
                document.getElementById('old-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } else showError(res?.error || 'Error!');
        }
        function setTheme(theme) {
            localStorage.setItem('theme', theme); applyTheme(); updateButtons();
            apiCall('/api/user/profile', 'PUT', { theme });
        }
        function setLanguage(newLang) {
            localStorage.setItem('language', newLang);
            apiCall('/api/user/profile', 'PUT', { language: newLang });
            location.reload();
        }
        function updateButtons() {
            const theme = localStorage.getItem('theme') || 'dark';
            const currentLang = localStorage.getItem('language') || 'vi';
            document.getElementById('theme-dark').classList.toggle('active', theme === 'dark');
            document.getElementById('theme-light').classList.toggle('active', theme === 'light');
            document.getElementById('lang-vi').classList.toggle('active', currentLang === 'vi');
            document.getElementById('lang-en').classList.toggle('active', currentLang === 'en');
        }
    </script>
</body>
</html>
